<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Engame Quiz</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        const event_handlers = {
            events: [],
            add_event: (type, id) => {
                event_handlers.events.push({"type": type, "id": id})
            }
        }

        const renderer_module = {
            setup_event_callback: component => {
                if(component.id === null) return
                switch (component.type){
                    case "button":
                        document.getElementById(component.id).addEventListener('click', () => {
                            event_handlers.add_event("button_pressed", component.id)
                        })
                    default:
                    case "text":
                        break;
                }
            },
            render: (components) => {
                document.getElementById("app").innerHTML = ""
                JSON.parse(components).forEach((component, _, __) => {
                    document.getElementById("app").innerHTML += component.content
                    renderer_module.setup_event_callback(component)
                })
            },
            get_events: () => {
                let events = event_handlers.events
                event_handlers.events = []
                return events
            }
        }

        async function main(){
            let pyodide = await loadPyodide();
            // Load packages
            await pyodide.loadPackage("pyyaml")
            await pyodide.loadPackage("requests")
            pyodide.registerJsModule("web", renderer_module)
            // Load the source code
            let resp = await fetch("http://" + window.location.host + "/source.zip")
            let buffer = await resp.arrayBuffer()
            await pyodide.unpackArchive(buffer, "zip")
            pyodide.pyimport("main")
            await pyodide.runPythonAsync(`
                import main
                main.main()
            `)
        }

        main();
    </script>
</body>
</html>