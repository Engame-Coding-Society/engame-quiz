<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Engame Quiz</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        #app {
            justify-self: center;
            display: block;
            max-width: 500px;
            max-height: 600px;
        }

        #app-frame {
            display: flex;
        }

        p, button{
            text-align: center;
            font-size: 36pt;
            font-weight: bold;
        }

        .leaderboard-heading {
            text-decoration: underline;
            margin-bottom: -10px;
        }
    </style>
</head>
<body>
    <div id="app-frame">
        <div id="app"></div>
    </div>
    <script>
        const event_handlers = {
            events: [],
            add_event: (type, id, args=null) => {
                let event = {"type": type, "id": id}
                event_handlers.events.push((args === null) ? event : {...event, ...args})
            }
        }

        const renderer_module = {
            setup_event_callback: component => {
                if(component.id === null) return
                let element = $(`#${component.id}`)
                switch (component.type){
                    case "button":
                        element.on('click', () => event_handlers.add_event("button_pressed", component.id))
                        break;
                    case "entry":
                        element.on('change', () => event_handlers.add_event("entry_changed", component.id,
                            {value: element.val()}))
                        break;
                    default:
                        break;
                }
            },
            render: (components) => {
                $("#app").html("")
                JSON.parse(components).forEach((component, _, __) => {
                    $("#app").append($(component.content))
                    renderer_module.setup_event_callback(component)
                })
            },
            get_events: () => {
                let events = event_handlers.events
                event_handlers.events = []
                return events
            }
        }

        async function main(){
            let pyodide = await loadPyodide();
            // Load packages
            await pyodide.loadPackage("pyyaml")
            await pyodide.loadPackage("requests")
            pyodide.registerJsModule("web", renderer_module)
            // Load the source code
            let resp = await fetch(window.location.protocol + "//" + window.location.host + "/source.zip")
            let buffer = await resp.arrayBuffer()
            await pyodide.unpackArchive(buffer, "zip")
            pyodide.pyimport("main")
            await pyodide.runPythonAsync(`
                import main
                main.main()
            `)
        }

        main();
    </script>
</body>
</html>